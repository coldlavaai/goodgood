{%- comment -%}
  Sticky Add to Cart Bar for Mobile
  Shows when user scrolls past the main add to cart button
  Improves mobile conversion by keeping CTA accessible
{%- endcomment -%}

<style>
  #sticky-atc {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 999;
    background: var(--color-scheme-background, #ffffff);
    border-top: 2px solid var(--color-scheme-text, #024638);
    padding: 12px 16px;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
    display: none;
  }

  #sticky-atc.visible {
    transform: translateY(0);
  }

  #sticky-atc.show {
    display: flex;
  }

  #sticky-atc-inner {
    display: flex;
    align-items: center;
    gap: 12px;
    max-width: 100%;
    margin: 0 auto;
  }

  #sticky-atc-image {
    width: 48px;
    height: 48px;
    object-fit: cover;
    border-radius: 8px;
    border: 2px solid var(--color-scheme-text, #024638);
    flex-shrink: 0;
  }

  #sticky-atc-info {
    flex: 1;
    min-width: 0;
  }

  #sticky-atc-title {
    font-weight: 600;
    font-size: 14px;
    line-height: 1.2;
    margin-bottom: 4px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: var(--color-scheme-text, #024638);
  }

  #sticky-atc-price {
    font-size: 16px;
    font-weight: 700;
    color: var(--color-scheme-text, #024638);
  }

  #sticky-atc-button {
    flex-shrink: 0;
    padding: 12px 24px;
    font-weight: 600;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-radius: 8px;
    border: 2px solid var(--color-scheme-text, #024638);
    background: var(--color-scheme-accent-1, #f7ced7);
    color: var(--color-scheme-text, #024638);
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  #sticky-atc-button:hover {
    transform: translateY(-2px);
    box-shadow: 4px 4px 0 var(--color-scheme-text, #024638);
  }

  #sticky-atc-button:active {
    transform: translateY(0);
    box-shadow: 2px 2px 0 var(--color-scheme-text, #024638);
  }

  #sticky-atc-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  /* Hide on desktop */
  @media (min-width: 1024px) {
    #sticky-atc {
      display: none !important;
    }
  }
</style>

<div id="sticky-atc" role="region" aria-label="Sticky add to cart">
  <div id="sticky-atc-inner">
    {% if product.featured_image %}
      <img
        id="sticky-atc-image"
        src="{{ product.featured_image | image_url: width: 96 }}"
        alt="{{ product.title | escape }}"
        loading="lazy"
        width="48"
        height="48"
      >
    {% endif %}

    <div id="sticky-atc-info">
      <div id="sticky-atc-title">{{ product.title }}</div>
      <div id="sticky-atc-price" data-product-price>
        {{ product.selected_or_first_available_variant.price | money }}
      </div>
    </div>

    <button
      id="sticky-atc-button"
      type="button"
      aria-label="Add to cart"
    >
      Add to Cart
    </button>
  </div>
</div>

<script>
(function() {
  // Only run on product pages
  if (!document.querySelector('[data-product-form]')) return;

  const stickyBar = document.getElementById('sticky-atc');
  const stickyButton = document.getElementById('sticky-atc-button');
  const mainForm = document.querySelector('[data-product-form]');
  const mainAddToCartButton = mainForm ? mainForm.querySelector('[type="submit"], button[name="add"]') : null;

  let lastScrollY = window.scrollY;
  let ticking = false;

  // Show sticky bar when main button is out of view
  function updateStickyBar() {
    if (!mainAddToCartButton || !stickyBar) return;

    const buttonRect = mainAddToCartButton.getBoundingClientRect();
    const isButtonVisible = buttonRect.top >= 0 && buttonRect.bottom <= window.innerHeight;

    if (!isButtonVisible && window.scrollY > 300) {
      stickyBar.classList.add('show');
      requestAnimationFrame(() => {
        stickyBar.classList.add('visible');
      });
    } else {
      stickyBar.classList.remove('visible');
      setTimeout(() => {
        if (!stickyBar.classList.contains('visible')) {
          stickyBar.classList.remove('show');
        }
      }, 300);
    }
  }

  // Throttled scroll handler
  function onScroll() {
    lastScrollY = window.scrollY;
    if (!ticking) {
      window.requestAnimationFrame(() => {
        updateStickyBar();
        ticking = false;
      });
      ticking = true;
    }
  }

  // Handle sticky button click
  if (stickyButton) {
    stickyButton.addEventListener('click', function() {
      if (mainAddToCartButton) {
        // Scroll to main button and click it
        mainAddToCartButton.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // Click after scroll completes
        setTimeout(() => {
          mainAddToCartButton.click();
        }, 500);
      }
    });
  }

  // Update price when variant changes
  if (mainForm) {
    mainForm.addEventListener('change', function(e) {
      if (e.target.name === 'id' || e.target.closest('[data-variant-picker]')) {
        const priceElement = document.getElementById('sticky-atc-price');
        const mainPriceElement = mainForm.querySelector('[data-product-price]');

        if (priceElement && mainPriceElement) {
          // Wait a bit for the main price to update
          setTimeout(() => {
            const priceText = mainPriceElement.textContent.trim();
            if (priceText) {
              priceElement.textContent = priceText;
            }
          }, 100);
        }
      }
    });
  }

  // Initialize
  window.addEventListener('scroll', onScroll, { passive: true });
  window.addEventListener('resize', updateStickyBar);

  // Initial check
  setTimeout(updateStickyBar, 500);

  // Clean up on page unload
  window.addEventListener('beforeunload', () => {
    window.removeEventListener('scroll', onScroll);
    window.removeEventListener('resize', updateStickyBar);
  });
})();
</script>
